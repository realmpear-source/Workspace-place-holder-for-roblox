-- ========== SERVICES ==========
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local localPlayer = Players.LocalPlayer

-- ========== CONNECTION MANAGER ==========
local ConnectionManager = {}
ConnectionManager.__index = ConnectionManager

function ConnectionManager.new()
    return setmetatable({_connections = {}}, ConnectionManager)
end

function ConnectionManager:Add(connection)
    if connection then table.insert(self._connections, connection) end
    return connection
end

function ConnectionManager:DisconnectAll()
    for _, conn in ipairs(self._connections) do
        if typeof(conn) == "RBXScriptConnection" then conn:Disconnect() end
    end
    self._connections = {}
end

function ConnectionManager:Destroy() self:DisconnectAll() end

-- ========== CONFIGURATION ==========
local COLORS = {
    survivor = Color3.fromRGB(0, 255, 255),
    killer = Color3.fromRGB(255, 100, 100),
    item = Color3.fromRGB(255, 255, 0),
    generator = Color3.fromRGB(50, 255, 50),
    minion = Color3.fromRGB(170, 0, 255),
    survivorAbility = Color3.fromRGB(255, 165, 0),
    killerAbility = Color3.fromRGB(255, 50, 150)
}

local OBJECT_NAMES = {
    items = {"Medkit", "BloxyCola"},
    minions = {"PizzaDeliveryRig", "1x1x1x1Zombie", "Mafia1", "Mafia2", "Mafia3", "Mafia4", "BlueGuy", "RedGuy", "PurpleGuy", "GreenGuy"},
    survivorAbilities = {"SubspaceTripmine", "pizza"},
    killerAbilities = {"Swords", "Shockwave", "Voidstar", "HumanoidRootProjectile"}
}

local SETTINGS = {
    Keybind = Enum.KeyCode.X,
    GenTime = 2.5,
    MaxAttempts = 1,
    AutoFix = false,
    AutoFixDelay = 1,
    HighlightRefreshRate = 1,
    BillboardUpdateRate = 0.1
}

local ESP_SETTINGS = {
    players = true,
    items = true,
    generators = true,
    survivorAbilities = true,
    killerAbilities = true,
    minions = true
}

-- ========== STATE MANAGEMENT ==========
local State = {
    activeHighlights = setmetatable({}, {__mode = "v"}),
    playerBillboards = setmetatable({}, {__mode = "v"}),
    generatorBillboards = setmetatable({}, {__mode = "v"}),
    mainConnections = ConnectionManager.new(),
    highlightConnections = ConnectionManager.new(),
    billboardUpdateConnection = nil,
    characterDied = false,
    active = false,
    currentGenerator = nil,
    highlightEnabled = true,
    lastHighlightUpdate = 0,
    autoFixRunning = false,
    IsEnabled = true,
    lastPopupCheck = 0,
    PopupCheckRate = 0.1
}

-- ========== UTILITY FUNCTIONS ==========
local function safeCall(func, context)
    local success, result = pcall(func)
    if not success then warn(string.format("[%s] Error: %s", context or "Unknown", result)) end
    return success and result
end

local function isPlayerAlive()
    if State.characterDied then return false end
    return safeCall(function()
        local character = localPlayer.Character
        local humanoid = character and character:FindFirstChildOfClass("Humanoid")
        return humanoid and humanoid.Health > 0
    end, "isPlayerAlive") or false
end

local function getLocalPlayerRoot()
    return safeCall(function()
        local character = localPlayer.Character
        return character and character:FindFirstChild("HumanoidRootPart")
    end, "getLocalPlayerRoot")
end

local function isValidObject(obj)
    return safeCall(function()
        return obj and (obj:IsA("Model") or obj:IsA("BasePart"))
    end, "isValidObject") or false
end

local function isLocalPlayerModel(model)
    if not model then return false end
    return safeCall(function()
        if model == localPlayer.Character then return true end
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= localPlayer and player.Character == model then return false end
        end
        return false
    end, "isLocalPlayerModel") or false
end

-- ========== BILLBOARD MANAGEMENT ==========
local function cleanupBillboard(parent, billboardDict)
    safeCall(function()
        local billboard = billboardDict[parent]
        if billboard and billboard.Parent then billboard:Destroy() end
        billboardDict[parent] = nil
    end, "cleanupBillboard")
end

local function clearAllBillboards()
    safeCall(function()
        for parent, billboard in pairs(State.playerBillboards) do
            if billboard and billboard.Parent then billboard:Destroy() end
            State.playerBillboards[parent] = nil
        end
        for parent, billboard in pairs(State.generatorBillboards) do
            if billboard and billboard.Parent then billboard:Destroy() end
            State.generatorBillboards[parent] = nil
        end
    end, "clearAllBillboards")
end

local function createPlayerBillboard(parent, color, playerType)
    if isLocalPlayerModel(parent) then return nil end
    if not parent or not parent.Parent or State.playerBillboards[parent] then return nil end
    
    return safeCall(function()
        local attachTo = parent:FindFirstChild("HumanoidRootPart") or parent:FindFirstChild("Torso") or parent:FindFirstChild("UpperTorso")
        if not attachTo then return nil end
        
        local billboard = Instance.new("BillboardGui")
        billboard.Name = playerType .. "Distance"
        billboard.AlwaysOnTop = true
        billboard.Size = UDim2.new(0, 100, 0, 30)
        billboard.StudsOffset = Vector3.new(0, -2.5, 0)
        billboard.MaxDistance = 220
        billboard.Parent = attachTo
        
        local textLabel = Instance.new("TextLabel")
        textLabel.BackgroundTransparency = 1
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.Font = Enum.Font.SourceSansBold
        textLabel.TextSize = 14
        textLabel.TextColor3 = color
        textLabel.TextStrokeTransparency = 0.7
        textLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
        textLabel.Text = "Loading..."
        textLabel.Parent = Instance.new("Frame", billboard)
        
        State.playerBillboards[parent] = billboard
        
        attachTo.AncestryChanged:Connect(function(_, newParent)
            if newParent == nil then cleanupBillboard(parent, State.playerBillboards) end
        end)
        
        return billboard
    end, "createPlayerBillboard") or nil
end

local function createGeneratorBillboard(parent)
    if not parent or not parent.Parent or State.generatorBillboards[parent] then return nil end
    
    return safeCall(function()
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "GeneratorProgress"
        billboard.AlwaysOnTop = true
        billboard.Size = UDim2.new(0, 120, 0, 25)
        billboard.StudsOffset = Vector3.new(0, -3.5, 0)
        billboard.MaxDistance = 75
        billboard.Parent = parent
        
        local textLabel = Instance.new("TextLabel")
        textLabel.BackgroundTransparency = 1
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.Font = Enum.Font.SourceSansBold
        textLabel.TextSize = 12
        textLabel.TextColor3 = Color3.new(1, 1, 1)
        textLabel.TextStrokeTransparency = 0.7
        textLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
        textLabel.Text = "0%"
        textLabel.Parent = Instance.new("Frame", billboard)
        
        State.generatorBillboards[parent] = billboard
        
        local progress = parent:FindFirstChild("Progress")
        if progress then
            State.highlightConnections:Add(progress:GetPropertyChangedSignal("Value"):Connect(function()
                if progress.Value >= 100 then
                    cleanupHighlight(parent)
                elseif textLabel and textLabel.Parent then
                    textLabel.Text = string.format("Progress: %d%%", math.floor(progress.Value))
                end
            end))
        end
        
        parent.AncestryChanged:Connect(function(_, newParent)
            if newParent == nil then cleanupBillboard(parent, State.generatorBillboards) end
        end)
        
        return billboard
    end, "createGeneratorBillboard") or nil
end

local function updateBillboards()
    if not State.highlightEnabled or not isPlayerAlive() then return end
    
    safeCall(function()
        local localRoot = getLocalPlayerRoot()
        if not localRoot then return end
        
        for playerModel, billboard in pairs(State.playerBillboards) do
            if playerModel and playerModel.Parent and billboard and billboard.Parent then
                if isLocalPlayerModel(playerModel) then
                    cleanupBillboard(playerModel, State.playerBillboards)
                else
                    local humanoidRoot = playerModel:FindFirstChild("HumanoidRootPart")
                    if humanoidRoot then
                        local distance = math.floor((humanoidRoot.Position - localRoot.Position).Magnitude + 0.5)
                        local textLabel = billboard:FindFirstChild("Frame") and billboard.Frame:FindFirstChild("TextLabel")
                        if textLabel then textLabel.Text = distance .. " studs" end
                    else
                        cleanupBillboard(playerModel, State.playerBillboards)
                    end
                end
            else
                cleanupBillboard(playerModel, State.playerBillboards)
            end
        end
    end, "updateBillboards")
end

-- ========== HIGHLIGHT MANAGEMENT ==========
local function cleanupHighlight(parent)
    safeCall(function()
        local highlight = State.activeHighlights[parent]
        if highlight and highlight.Parent then highlight:Destroy() end
        State.activeHighlights[parent] = nil
        cleanupBillboard(parent, State.playerBillboards)
        cleanupBillboard(parent, State.generatorBillboards)
    end, "cleanupHighlight")
end

local function clearAllHighlights()
    safeCall(function()
        for parent, highlight in pairs(State.activeHighlights) do
            if highlight and highlight.Parent then highlight:Destroy() end
            State.activeHighlights[parent] = nil
        end
        clearAllBillboards()
    end, "clearAllHighlights")
end

local function createHighlight(parent, color)
    if not parent or not parent.Parent or State.activeHighlights[parent] then return nil end
    
    return safeCall(function()
        local highlight = Instance.new("Highlight")
        highlight.FillTransparency = 1
        highlight.OutlineColor = color
        highlight.OutlineTransparency = 0.3
        highlight.Parent = parent
        
        State.activeHighlights[parent] = highlight
        
        parent.AncestryChanged:Connect(function(_, newParent)
            if newParent == nil then cleanupHighlight(parent) end
        end)
        
        return highlight
    end, "createHighlight") or nil
end

-- ========== OBJECT SCANNERS ==========
local function processObjectCollection(names, color, conditionCheck)
    conditionCheck = conditionCheck or function() return true end
    
    safeCall(function()
        for _, obj in ipairs(workspace:GetDescendants()) do
            if isValidObject(obj) and names[obj.Name] and conditionCheck(obj) then
                createHighlight(obj, color)
            end
        end
        
        State.highlightConnections:Add(workspace.DescendantAdded:Connect(function(descendant)
            if isValidObject(descendant) and names[descendant.Name] and conditionCheck(descendant) then
                createHighlight(descendant, color)
            end
        end))
    end, "processObjectCollection")
end

local function highlightPlayers()
    if not ESP_SETTINGS.players then return end
    
    safeCall(function()
        local playersFolder = workspace:FindFirstChild("Players")
        if not playersFolder then return end
        
        local function processPlayerGroup(group, color, playerType)
            if not group then return end
            
            for _, playerModel in ipairs(group:GetChildren()) do
                if playerModel:IsA("Model") and not isLocalPlayerModel(playerModel) then
                    createHighlight(playerModel, color)
                    createPlayerBillboard(playerModel, color, playerType)
                end
            end
            
            State.highlightConnections:Add(group.ChildAdded:Connect(function(child)
                if child:IsA("Model") and not isLocalPlayerModel(child) then
                    createHighlight(child, color)
                    createPlayerBillboard(child, color, playerType)
                end
            end))
        end
        
        processPlayerGroup(playersFolder:FindFirstChild("Survivors"), COLORS.survivor, "Survivor")
        processPlayerGroup(playersFolder:FindFirstChild("Killers"), COLORS.killer, "Killer")
    end, "highlightPlayers")
end

local function highlightGenerators()
    if not ESP_SETTINGS.generators then return end
    
    safeCall(function()
        local mapFolder = workspace:FindFirstChild("Map")
        local ingame = mapFolder and mapFolder:FindFirstChild("Ingame")
        local generators = ingame and ingame:FindFirstChild("Map")
        if not generators then return end
        
        local function isGeneratorValid(gen)
            if not gen:IsA("Model") then return false end
            local progress = gen:FindFirstChild("Progress")
            return progress and progress.Value < 100
        end
        
        for _, gen in ipairs(generators:GetChildren()) do
            if gen.Name == "Generator" and isGeneratorValid(gen) then
                createHighlight(gen, COLORS.generator)
                createGeneratorBillboard(gen)
            end
        end
        
        State.highlightConnections:Add(generators.ChildAdded:Connect(function(child)
            if child.Name == "Generator" and isGeneratorValid(child) then
                createHighlight(child, COLORS.generator)
                createGeneratorBillboard(child)
            end
        end))
    end, "highlightGenerators")
end

local function highlightCategory(category, color, objectNames)
    if not ESP_SETTINGS[category] then return end
    
    local nameMap = {}
    for _, name in ipairs(objectNames) do nameMap[name] = true end
    
    processObjectCollection(nameMap, color)
end

-- ========== SCAN MANAGEMENT ==========
local function rescanHighlights()
    if not State.highlightEnabled then return end
    
    safeCall(function()
        clearAllHighlights()
        State.highlightConnections:DisconnectAll()
        
        highlightPlayers()
        highlightGenerators()
        highlightCategory("items", COLORS.item, OBJECT_NAMES.items)
        highlightCategory("minions", COLORS.minion, OBJECT_NAMES.minions)
        highlightCategory("survivorAbilities", COLORS.survivorAbility, OBJECT_NAMES.survivorAbilities)
        highlightCategory("killerAbilities", COLORS.killerAbility, OBJECT_NAMES.killerAbilities)
    end, "rescanHighlights")
end

local function toggleHighlights()
    State.highlightEnabled = not State.highlightEnabled
    
    safeCall(function()
        if State.highlightEnabled then
            rescanHighlights()
            if State.billboardUpdateConnection then State.billboardUpdateConnection:Disconnect() end
            State.billboardUpdateConnection = RunService.Heartbeat:Connect(function()
                if tick() - State.lastHighlightUpdate > SETTINGS.BillboardUpdateRate then
                    updateBillboards()
                    State.lastHighlightUpdate = tick()
                end
            end)
        else
            clearAllHighlights()
            State.highlightConnections:DisconnectAll()
            if State.billboardUpdateConnection then
                State.billboardUpdateConnection:Disconnect()
                State.billboardUpdateConnection = nil
            end
        end
    end, "toggleHighlights")
end

-- ========== AUTO POPUP SYSTEM ==========
local function handleAutoPopups()
    while true do
        if State.IsEnabled then
            safeCall(function()
                local playerGui = localPlayer:FindFirstChild("PlayerGui")
                local temporaryUI = playerGui and playerGui:FindFirstChild("TemporaryUI")
                
                if temporaryUI then
                    for _, popup in ipairs(temporaryUI:GetChildren()) do
                        if popup.Name == "1x1x1x1Popup" then
                            local centerX = popup.AbsolutePosition.X + (popup.AbsoluteSize.X / 2)
                            local centerY = popup.AbsolutePosition.Y + (popup.AbsoluteSize.Y / 2) + 50
                            
                            VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, true, playerGui, 1)
                            VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, false, playerGui, 1)
                        end
                    end
                end
            end, "handleAutoPopups")
        end
        task.wait(State.PopupCheckRate)
    end
end

-- ========== GENERATOR REPAIR SYSTEM ==========
local function validateGenerator(generator)
    if not generator or not generator.Parent then return false end
    
    return safeCall(function()
        return generator:FindFirstChild("Progress") and
               generator:FindFirstChild("Main") and
               generator.Main:FindFirstChild("Prompt") and
               generator:FindFirstChild("Remotes") and
               generator.Remotes:FindFirstChild("RE")
    end, "validateGenerator") or false
end

local function getClosestGenerator()
    if not isPlayerAlive() then return nil end
    
    return safeCall(function()
        local character = localPlayer.Character
        local rootPart = character and character:FindFirstChild("HumanoidRootPart")
        if not rootPart then return nil end
        
        local closest = nil
        local minDistance = math.huge
        
        local map = workspace:FindFirstChild("Map")
        local ingame = map and map:FindFirstChild("Ingame")
        local generators = ingame and ingame:FindFirstChild("Map")
        
        if not generators then return nil end
        
        for _, generator in ipairs(generators:GetDescendants()) do
            if generator.Name == "Generator" and validateGenerator(generator) then
                local progress = generator.Progress.Value
                if progress < 100 then
                    local distance = (generator:GetPivot().Position - rootPart.Position).Magnitude
                    if distance < minDistance then
                        minDistance = distance
                        closest = generator
                    end
                end
            end
        end
        
        return closest
    end, "getClosestGenerator") or nil
end

local function attemptFixGenerator()
    if State.active or not isPlayerAlive() then return end
    
    State.active = true
    
    safeCall(function()
        local generator = getClosestGenerator()
        if not generator then return end
        
        State.currentGenerator = generator
        local prompt = generator.Main.Prompt
        
        for _ = 1, 3 do
            if not State.active or not isPlayerAlive() then break end
            if prompt and prompt.Parent then fireproximityprompt(prompt, 1) end
            task.wait(0.1)
        end
        
        for i = 1, SETTINGS.MaxAttempts do
            if not State.active or not isPlayerAlive() or not validateGenerator(generator) or generator.Progress.Value >= 100 then 
                break 
            end
            
            generator.Remotes.RE:FireServer()
            
            if i < SETTINGS.MaxAttempts and generator.Progress.Value < 100 then
                task.wait(SETTINGS.GenTime)
            end
        end
    end, "attemptFixGenerator")
    
    State.active = false
    State.currentGenerator = nil
end

local function autoFixLoop()
    if State.autoFixRunning then return end
    
    State.autoFixRunning = true
    
    safeCall(function()
        while SETTINGS.AutoFix and State.autoFixRunning do
            if not State.active and isPlayerAlive() and getClosestGenerator() then
                attemptFixGenerator()
            end
            task.wait(SETTINGS.AutoFixDelay)
        end
    end, "autoFixLoop")
    
    State.autoFixRunning = false
end

-- ========== EVENT HANDLERS ==========
local function onCharacterDeath()
    State.characterDied = true
    State.active = false
    State.currentGenerator = nil
    clearAllHighlights()
end

local function onCharacterAdded(character)
    State.characterDied = false
    
    safeCall(function()
        local humanoid = character:WaitForChild("Humanoid", 5)
        if humanoid then humanoid.Died:Connect(onCharacterDeath) end
        
        task.wait(1)
        if State.highlightEnabled then rescanHighlights() end
    end, "onCharacterAdded")
end

-- ========== INPUT HANDLING ==========
local function setupInputHandlers()
    if not SETTINGS.AutoFix then
        State.mainConnections:Add(UserInputService.InputBegan:Connect(function(input, gameProcessed)
            if not gameProcessed and input.KeyCode == SETTINGS.Keybind then
                task.spawn(attemptFixGenerator)
            end
        end))
    end
    
    State.mainConnections:Add(UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if not gameProcessed and input.KeyCode == Enum.KeyCode.P then
            toggleHighlights()
        end
    end))
end

-- ========== INITIALIZATION ==========
local function initialize()
    if not localPlayer then
        repeat task.wait(0.1) until localPlayer
    end
    
    safeCall(function()
        setupInputHandlers()
        
        if localPlayer.Character then
            local humanoid = localPlayer.Character:FindFirstChildOfClass("Humanoid")
            if humanoid then humanoid.Died:Connect(onCharacterDeath) end
        end
        
        State.mainConnections:Add(localPlayer.CharacterAdded:Connect(onCharacterAdded))
        
        State.mainConnections:Add(RunService.Heartbeat:Connect(function()
            if State.highlightEnabled and tick() - State.lastHighlightUpdate > SETTINGS.HighlightRefreshRate then
                State.lastHighlightUpdate = tick()
            end
        end))
        
        if SETTINGS.AutoFix then task.spawn(autoFixLoop) end
        
        task.spawn(handleAutoPopups)
        
        if State.highlightEnabled then
            rescanHighlights()
            State.billboardUpdateConnection = RunService.Heartbeat:Connect(function()
                if tick() - State.lastHighlightUpdate > SETTINGS.BillboardUpdateRate then
                    updateBillboards()
                    State.lastHighlightUpdate = tick()
                end
            end)
        end
    end, "initialize")
    
    return true
end

local function cleanup()
    safeCall(function()
        State.active = false
        State.autoFixRunning = false
        State.IsEnabled = false
        
        State.mainConnections:Destroy()
        State.highlightConnections:DisconnectAll()
        
        if State.billboardUpdateConnection then
            State.billboardUpdateConnection:Disconnect()
            State.billboardUpdateConnection = nil
        end
        
        clearAllHighlights()
        clearAllBillboards()
    end, "cleanup")
end

-- ========== MAIN EXECUTION ==========
local success = pcall(initialize)
if not success then cleanup() end

return cleanup
