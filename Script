local range = 27
local auratrue = false
local keybind = Enum.KeyCode.X
local zombies = workspace:WaitForChild("Zombies")
local player = game.Players.LocalPlayer

-- List of valid weapons
local validWeapons = {
    "Pickaxe", "Sabre", "Axe", "OfficerSabre",
    "HeavySabre", "Stake", "Lance", "Spoonton"
}

-- Error handling for missing remotes
local function getRemote(name, path)
    local success, remote = pcall(function() return path:WaitForChild(name, 5) end)
    return success and remote or warn("Remote not found:", name)
end

local gib = getRemote("Gib", game.ReplicatedStorage.Remotes)

-- Find weapon remote with constant inventory checking
local function findWeaponRemote()
    local containers = {player.Backpack, player.Character}
    
    for _, container in ipairs(containers) do
        if not container then continue end
        
        for _, weaponName in ipairs(validWeapons) do
            local weapon = container:FindFirstChild(weaponName)
            if weapon then
                local remote = weapon:FindFirstChild("RemoteEvent")
                if remote then
                    return remote, weaponName
                end
            end
        end
    end
    
    return nil
end

-- Check if item is valid zombie
local function isValidZombie(item)
    if not item:IsA("Model") then return false end
    if not item:FindFirstChild("HumanoidRootPart") then return false end
    
    local folder = item.Parent
    if folder and folder.Name == "Camera" and item.Name ~= "m_Zombie" then
        return false
    end
    
    return true
end

-- Get closest zombie to player
local function getClosestZombie()
    local char = player.Character
    if not char then return nil end
    local root = char:FindFirstChild("HumanoidRootPart")
    if not root then return nil end
    
    local closestDist = math.huge
    local closestZombie = nil
    
    for _, item in ipairs(zombies:GetChildren()) do
        if isValidZombie(item) then
            local zRoot = item.HumanoidRootPart
            local dist = (zRoot.Position - root.Position).Magnitude
            
            if dist < closestDist then
                closestDist = dist
                closestZombie = item
            end
        end
    end
    
    return closestZombie, closestDist
end

-- Make character look at zombie
local function lookAtZombie(zombie)
    local char = player.Character
    if not char then return end
    local humanoid = char:FindFirstChild("Humanoid")
    local root = char:FindFirstChild("HumanoidRootPart")
    local zRoot = zombie and zombie:FindFirstChild("HumanoidRootPart")
    
    if root and zRoot then
        local direction = (zRoot.Position - root.Position).Unit
        
        -- Create a new CFrame that looks at the zombie
        root.CFrame = CFrame.new(root.Position, 
            Vector3.new(zRoot.Position.X, root.Position.Y, zRoot.Position.Z))
        
        -- Also rotate humanoid if it exists
        if humanoid then
            humanoid:MoveTo(zRoot.Position)
        end
    end
end

-- Attack function
local function attackZombies()
    if not auratrue then return end
    
    -- Find current weapon
    local weaponRemote, weaponName = findWeaponRemote()
    if not weaponRemote then
        warn("No valid weapon found")
        return
    end
    
    -- Get closest zombie
    local closestZombie, dist = getClosestZombie()
    if not closestZombie or dist > range then return end
    
    -- Make character look at zombie
    lookAtZombie(closestZombie)
    
    -- Attack the zombie
    local zHead = closestZombie:FindFirstChild("Head")
    if zHead then
        local char = player.Character
        local root = char and char:FindFirstChild("HumanoidRootPart")
        if not root then return end
        
        local hitPos = zHead.Position
        local dir = (hitPos - root.Position).Unit
        
        -- Fire weapon swing
        pcall(function()
            weaponRemote:FireServer("Swing", "Over")
            if gib then 
                gib:FireServer(closestZombie, "Head", hitPos, dir)
            end
            weaponRemote:FireServer("HitZombie", closestZombie, hitPos, false)
        end)
        
        print("Attacked zombie with", weaponName)
    end
end

-- Keybind setup
game:GetService("UserInputService").InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == keybind then
        auratrue = not auratrue
        print("Kill Aura:", auratrue and "ON" or "OFF")
    end
end)

-- Connection to detect when player dies/respawns
player.CharacterAdded:Connect(function()
    print("Character loaded, ready for kill aura")
end)

-- Main loop with inventory checking
while true do
    if auratrue then
        attackZombies()
    end
    task.wait(0.2)
end
