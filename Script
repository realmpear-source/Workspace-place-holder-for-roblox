local range = 27
local auratrue = false
local keybind = Enum.KeyCode.X
local zombies = workspace:WaitForChild("Zombies")
local player = game.Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local root = char:WaitForChild("HumanoidRootPart")

-- List of weapon names to check
local weaponNames = {
    "Pickaxe", "Sabre", "Spontoon", "Axe", "Hand Axe", 
    "Heavy Sabre", "Stake", "Officer Sabre", "Lance"
}

-- Cache for weapon remotes
local weaponRemotes = {}
local currentWeapon = nil

-- Error handling for missing remotes
local function getRemote(name, path)
    local success, remote = pcall(function() 
        return path:WaitForChild(name, 2)
    end)
    return success and remote or nil
end

local gib = getRemote("Gib", game.ReplicatedStorage.Remotes)

-- Find weapon remote with error handling
local function updateWeaponCache()
    weaponRemotes = {}
    
    -- Check character first (equipped weapons)
    for _, weaponName in ipairs(weaponNames) do
        local weapon = char:FindFirstChild(weaponName)
        if weapon then
            local remote = weapon:FindFirstChild("RemoteEvent")
            if remote then
                weaponRemotes[weaponName] = remote
                currentWeapon = weaponName
            end
        end
    end
    
    -- Check backpack (unequipped weapons)
    if player:FindFirstChild("Backpack") then
        for _, weaponName in ipairs(weaponNames) do
            if not weaponRemotes[weaponName] then
                local weapon = player.Backpack:FindFirstChild(weaponName)
                if weapon then
                    local remote = weapon:FindFirstChild("RemoteEvent")
                    if remote then
                        weaponRemotes[weaponName] = remote
                    end
                end
            end
        end
    end
    
    -- Set current weapon to first available
    if not currentWeapon and next(weaponRemotes) then
        for name in pairs(weaponRemotes) do
            currentWeapon = name
            break
        end
    end
end

-- Get current remote
local function getCurrentRemote()
    if currentWeapon and weaponRemotes[currentWeapon] then
        return weaponRemotes[currentWeapon]
    end
    
    -- Fallback to any available weapon
    for _, remote in pairs(weaponRemotes) do
        return remote
    end
    
    return nil
end

-- Make character face zombie
local function faceZombie(zombie)
    local humanoid = char:FindFirstChild("Humanoid")
    if humanoid and zombie:FindFirstChild("HumanoidRootPart") then
        local zPos = zombie.HumanoidRootPart.Position
        local lookVector = (zPos - root.Position).Unit
        humanoid:MoveTo(root.Position + lookVector * 5)
    end
end

-- Check if item is valid zombie
local function isValidZombie(item)
    if not item:IsA("Model") then return false end
    if not item:FindFirstChild("HumanoidRootPart") then return false end
    
    local folder = item.Parent
    if folder and folder.Name == "Camera" and item.Name ~= "m_Zombie" then
        return false
    end
    
    return true
end

-- Sort zombies by distance
local function getSortedZombies()
    local zombiesList = {}
    
    for _, item in ipairs(zombies:GetChildren()) do
        if isValidZombie(item) then
            table.insert(zombiesList, item)
        end
    end
    
    table.sort(zombiesList, function(a, b)
        local distA = (a.HumanoidRootPart.Position - root.Position).Magnitude
        local distB = (b.HumanoidRootPart.Position - root.Position).Magnitude
        return distA < distB
    end)
    
    return zombiesList
end

-- Attack with current weapon
local function attackWithWeapon(zombie, remote)
    if not remote then return false end
    
    local zHead = zombie:FindFirstChild("Head")
    if not zHead then return false end
    
    local hitPos = zHead.Position
    local dir = (hitPos - root.Position).Unit
    
    -- Face zombie before attacking
    faceZombie(zombie)
    
    -- Try different attack methods based on weapon type
    local success = pcall(function()
        if currentWeapon == "Sabre" or currentWeapon == "Heavy Sabre" or currentWeapon == "Officer Sabre" then
            remote:FireServer("Swing", "Over")
            if gib then gib:FireServer(zombie, "Head", hitPos, dir) end
            remote:FireServer("HitZombie", zombie, hitPos, false)
        elseif currentWeapon == "Axe" or currentWeapon == "Hand Axe" or currentWeapon == "Pickaxe" then
            remote:FireServer("Swing")
            if gib then gib:FireServer(zombie, "Head", hitPos, dir) end
            remote:FireServer("HitZombie", zombie, hitPos)
        elseif currentWeapon == "Lance" or currentWeapon == "Spontoon" or currentWeapon == "Stake" then
            remote:FireServer("Attack")
            if gib then gib:FireServer(zombie, "Head", hitPos, dir) end
            remote:FireServer("Hit", zombie, hitPos)
        else
            -- Generic attack for unknown weapons
            remote:FireServer("Attack")
            if gib then gib:FireServer(zombie, "Head", hitPos, dir) end
        end
    end)
    
    return success
end

-- Main kill aura function
local function attackZombies()
    if not auratrue then return end
    
    local remote = getCurrentRemote()
    if not remote then 
        updateWeaponCache()
        remote = getCurrentRemote()
        if not remote then return end
    end
    
    for _, zombie in ipairs(getSortedZombies()) do
        local zRoot = zombie.HumanoidRootPart
        if zRoot and (zRoot.Position - root.Position).Magnitude <= range then
            local success = attackWithWeapon(zombie, remote)
            if not success then
                -- Try to update weapon cache if attack failed
                updateWeaponCache()
            end
            break -- Attack one zombie at a time
        end
    end
end

-- Keybind setup
game:GetService("UserInputService").InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == keybind then
        auratrue = not auratrue
        print("Kill Aura:", auratrue and "ON" or "OFF")
        print("Current Weapon:", currentWeapon or "None")
    end
end)

-- Character change listener
player.CharacterAdded:Connect(function(newChar)
    char = newChar
    root = char:WaitForChild("HumanoidRootPart")
    updateWeaponCache()
end)

-- Initial weapon cache update
updateWeaponCache()

-- Main loop
while true do
    -- Update weapon cache every 5 seconds to check for new weapons
    if tick() % 5 < 0.1 then
        updateWeaponCache()
    end
    
    attackZombies()
    task.wait(0.2) -- Slightly slower for performance
end
