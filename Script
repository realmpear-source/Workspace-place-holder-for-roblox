local range = 30
local auratrue = false
local keybind = Enum.KeyCode.X
local zombies = workspace:WaitForChild("Zombies")
local player = game.Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local root = char:WaitForChild("HumanoidRootPart")
local humanoid = char:WaitForChild("Humanoid")

-- Weapon definitions
local swingWeapons = {"Pickaxe", "Sabre", "Axe", "OfficersSabre"}
local thrustWeapons = {"HeavySabre", "Stake", "pike", "Spontoon", "lance"}
local weaponsList = {}
for _, v in ipairs(swingWeapons) do weaponsList[v] = "Swing" end
for _, v in ipairs(thrustWeapons) do weaponsList[v] = "Thrust" end

-- Remote cache
local currentRemote = nil
local currentWeaponType = nil
local weaponName = nil

-- Get remote with error handling
local function getRemote(name, path)
    local success, result = pcall(function() return path:WaitForChild(name, 2) end)
    return success and result or nil
end

local gib = getRemote("Gib", game.ReplicatedStorage.Remotes)

-- Find weapon in containers
local function findWeaponRemote()
    for _, container in ipairs({player.Backpack, char}) do
        for weapon, attackType in pairs(weaponsList) do
            local weaponObj = container:FindFirstChild(weapon)
            if weaponObj then
                local remote = weaponObj:FindFirstChild("RemoteEvent")
                if remote then
                    currentWeaponType = attackType
                    weaponName = weapon
                    return remote
                end
            end
        end
    end
    currentWeaponType = nil
    weaponName = nil
    return nil
end

-- Monitor weapon changes
local function monitorWeapons(container)
    container.ChildAdded:Connect(function(child)
        if weaponsList[child.Name] then
            task.wait(0.1) -- Wait for RemoteEvent to be added
            currentRemote = findWeaponRemote()
        end
    end)
    
    container.ChildRemoved:Connect(function(child)
        if child.Name == weaponName then
            currentRemote = findWeaponRemote()
            if not currentRemote then auratrue = false end
        end
    end)
end

-- Initialize weapon monitoring
for _, container in ipairs({player.Backpack, char}) do
    monitorWeapons(container)
end

currentRemote = findWeaponRemote()

-- Check if item is valid zombie
local function isValidZombie(item)
    if not item:IsA("Model") then return false end
    if not item:FindFirstChild("HumanoidRootPart") then return false end
    
    local folder = item.Parent
    if folder and folder.Name == "Camera" and item.Name ~= "m_Zombie" then
        return false
    end
    
    return true
end

-- Get all zombies in range
local function getZombiesInRange()
    local zombiesInRange = {}
    for _, item in ipairs(zombies:GetChildren()) do
        if isValidZombie(item) then
            local zRoot = item.HumanoidRootPart
            if zRoot and (zRoot.Position - root.Position).Magnitude <= range then
                table.insert(zombiesInRange, item)
            end
        end
    end
    return zombiesInRange
end

-- Face nearest zombie
local function faceNearestZombie(zombiesInRange)
    if #zombiesInRange == 0 then return end
    
    local nearest = zombiesInRange[1]
    local nearestDist = (nearest.HumanoidRootPart.Position - root.Position).Magnitude
    
    for i = 2, #zombiesInRange do
        local dist = (zombiesInRange[i].HumanoidRootPart.Position - root.Position).Magnitude
        if dist < nearestDist then
            nearest = zombiesInRange[i]
            nearestDist = dist
        end
    end
    
    -- Face zombie without walking
    char:PivotTo(CFrame.new(root.Position, Vector3.new(
        nearest.HumanoidRootPart.Position.X,
        root.Position.Y,
        nearest.HumanoidRootPart.Position.Z
    )))
end

-- Attack all zombies in range
local function attackAllZombies()
    if not auratrue or not currentRemote or not currentWeaponType then return 0 end
    
    local zombiesInRange = getZombiesInRange()
    if #zombiesInRange == 0 then return 0 end
    
    -- Face nearest zombie
    faceNearestZombie(zombiesInRange)
    
    -- Fire attack animation once based on weapon type
    if currentWeaponType == "Swing" then
        pcall(function() currentRemote:FireServer("Swing", "Over") end)
    else -- Thrust
        pcall(function() currentRemote:FireServer("Thrust") end)
    end
    
    -- Attack all zombies in range
    local attackCount = 0
    for _, zombie in ipairs(zombiesInRange) do
        local zHead = zombie:FindFirstChild("Head")
        if zHead then
            local hitPos = zHead.Position
            local dir = (hitPos - root.Position).Unit
            
            pcall(function()
                -- Send hit event
                currentRemote:FireServer("HitZombie", zombie, hitPos, false)
                
                -- Send gib event if available
                if gib then
                    gib:FireServer(zombie, "Head", hitPos, dir)
                end
                
                attackCount += 1
            end)
        end
    end
    
    return attackCount
end

-- Handle death
local function handleDeath()
    auratrue = false
    print("Kill Aura: Disabled (Player died)")
end

-- Set up death monitoring
humanoid.Died:Connect(handleDeath)

-- Character respawn handling
player.CharacterAdded:Connect(function(newChar)
    char = newChar
    root = char:WaitForChild("HumanoidRootPart")
    humanoid = char:WaitForChild("Humanoid")
    
    -- Re-monitor for weapons
    currentRemote = findWeaponRemote()
    
    -- Set up death monitoring again
    humanoid.Died:Connect(handleDeath)
    
    -- Monitor new character for weapons
    monitorWeapons(char)
end)

-- Keybind setup
game:GetService("UserInputService").InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == keybind then
        if currentRemote then
            auratrue = not auratrue
            print("Kill Aura:", auratrue and "ON" or "OFF", "| Weapon:", weaponName or "None")
        else
            print("No weapon equipped!")
        end
    end
end)

-- Main loop
while true do
    if auratrue and humanoid.Health > 0 then
        local attacked = attackAllZombies()
        if attacked > 0 then
            task.wait(0.1) -- Attack cooldown
        else
            task.wait(0.2) -- Search cooldown
        end
    else
        task.wait(0.1)
    end
end
