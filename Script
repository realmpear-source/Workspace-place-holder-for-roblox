-- CONFIGURATION
local RANGE = 30
local KEYBIND = Enum.KeyCode.X
local WEAPONS = { "Sabre", "Axe" }
local UPDATE_INTERVAL = 0.1

-- SERVICES
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- GLOBALS
local auraEnabled = false
local player = Players.LocalPlayer
local character, rootPart, humanoid
local zombiesFolder = Workspace:WaitForChild("Zombies")
local gibRemote = game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("Gib")
local equippedWeapon, weaponRemote

-- INITIALIZE PLAYER
local function initializeCharacter()
    character = player.Character or player.CharacterAdded:Wait()
    rootPart = character:WaitForChild("HumanoidRootPart")
    humanoid = character:WaitForChild("Humanoid")
end

initializeCharacter()
player.CharacterAdded:Connect(initializeCharacter)

-- WEAPON MANAGEMENT
local function findWeapon()
    for _, weaponName in ipairs(WEAPONS) do
        -- Check character first
        local weapon = character:FindFirstChild(weaponName)
        if weapon and weapon:FindFirstChild("RemoteEvent") then
            return weapon, weapon.RemoteEvent
        end
        
        -- Check backpack
        if player.Backpack then
            local backpackWeapon = player.Backpack:FindFirstChild(weaponName)
            if backpackWeapon and backpackWeapon:FindFirstChild("RemoteEvent") then
                return backpackWeapon, backpackWeapon.RemoteEvent
            end
        end
    end
    return nil, nil
end

local function updateWeapon()
    equippedWeapon, weaponRemote = findWeapon()
    return weaponRemote ~= nil
end

-- Listen for weapon changes
local function monitorWeaponChanges()
    player.Backpack.ChildAdded:Connect(function(child)
        if table.find(WEAPONS, child.Name) then
            task.wait(0.2) -- Small delay for RemoteEvent to load
            updateWeapon()
        end
    end)
    
    character.ChildAdded:Connect(function(child)
        if table.find(WEAPONS, child.Name) then
            task.wait(0.2)
            updateWeapon()
        end
    end)
end

-- ZOMBIE MANAGEMENT
local function isValidZombie(zombie)
    if not zombie:IsA("Model") then return false end
    if not zombie.Parent then return false end
    
    local humanoidRootPart = zombie:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return false end
    
    -- Filter out non-zombies in Camera folder
    if zombie.Parent.Name == "Camera" and zombie.Name ~= "m_Zombie" then
        return false
    end
    
    return true
end

local function getZombiesInRange()
    local zombies = {}
    
    if not rootPart then return zombies end
    
    for _, zombie in ipairs(zombiesFolder:GetChildren()) do
        if isValidZombie(zombie) then
            local zombieRoot = zombie.HumanoidRootPart
            local distance = (zombieRoot.Position - rootPart.Position).Magnitude
            
            if distance <= RANGE then
                table.insert(zombies, {
                    model = zombie,
                    root = zombieRoot,
                    distance = distance
                })
            end
        end
    end
    
    -- Sort by distance
    table.sort(zombies, function(a, b)
        return a.distance < b.distance
    end)
    
    return zombies
end

-- FACE LOCKING
local function faceClosestZombie(zombies)
    if #zombies == 0 or not rootPart or humanoid and humanoid.Health <= 0 then
        return
    end
    
    local closestZombie = zombies[1]
    if closestZombie then
        -- Aggressive rotation to face zombie
        local lookAtPosition = Vector3.new(
            closestZombie.root.Position.X,
            rootPart.Position.Y,
            closestZombie.root.Position.Z
        )
        
        -- Smooth rotation using CFrame
        rootPart.CFrame = CFrame.new(
            rootPart.Position,
            lookAtPosition
        )
    end
end

-- ATTACK SYSTEM
local function attackZombie(zombie)
    if not weaponRemote or not rootPart then return false end
    
    local head = zombie.model:FindFirstChild("Head")
    if not head then return false end
    
    local hitPos = head.Position
    local direction = (hitPos - rootPart.Position).Unit
    
    local success = pcall(function()
        -- Swing weapon
        weaponRemote:FireServer("Swing", "Over")
        
        -- Gib remote
        gibRemote:FireServer(zombie.model, "Head", hitPos, direction)
        
        -- Hit zombie
        weaponRemote:FireServer("HitZombie", zombie.model, hitPos, false)
    end)
    
    return success
end

local function attackAllZombies(zombies)
    if #zombies == 0 or not auraEnabled then return end
    
    for _, zombie in ipairs(zombies) do
        attackZombie(zombie)
        -- No cooldown - immediate attacks
    end
end

-- MAIN LOOP
local function mainLoop()
    if not updateWeapon() then
        warn("No weapon found. Searching...")
        return
    end
    
    if not rootPart or (humanoid and humanoid.Health <= 0) then
        return
    end
    
    local zombies = getZombiesInRange()
    
    if #zombies > 0 then
        faceClosestZombie(zombies)
        attackAllZombies(zombies)
    end
end

-- KEYBIND HANDLER
UserInputService.InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == KEYBIND then
        auraEnabled = not auraEnabled
        print("[Kill Aura] " .. (auraEnabled and "ENABLED" or "DISABLED"))
    end
end)

-- SETUP MONITORING
monitorWeaponChanges()
updateWeapon()

-- STATUS DISPLAY
local function createStatusLabel()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "AuraStatus"
    screenGui.Parent = game:GetService("CoreGui")
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 150, 0, 40)
    frame.Position = UDim2.new(0.5, -75, 0, 10)
    frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    frame.BackgroundTransparency = 0.3
    frame.BorderSizePixel = 0
    frame.Parent = screenGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = frame
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = "Aura: OFF"
    label.TextColor3 = Color3.fromRGB(255, 50, 50)
    label.Font = Enum.Font.GothamBold
    label.TextSize = 18
    label.Parent = frame
    
    return label
end

local statusLabel = createStatusLabel()

-- UPDATE LOOP
RunService.Heartbeat:Connect(function()
    if statusLabel then
        statusLabel.Text = "Aura: " .. (auraEnabled and "ON" or "OFF")
        statusLabel.TextColor3 = auraEnabled and Color3.fromRGB(50, 255, 50) or Color3.fromRGB(255, 50, 50)
    end
    
    if auraEnabled then
        mainLoop()
    end
end)

-- INITIAL MESSAGE
print("[Kill Aura] Loaded successfully!")
print("[Kill Aura] Press " .. KEYBIND.Name .. " to toggle")
print("[Kill Aura] Supported weapons: " .. table.concat(WEAPONS, ", "))
