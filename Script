local range = 30
local auratrue = false
local keybind = Enum.KeyCode.X
local zombies = workspace:WaitForChild("Zombies")
local player = game.Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local root = char:WaitForChild("HumanoidRootPart")

-- Weapon remotes configuration
local weaponConfig = {
    ["Sabre"] = {"Swing", "Thrust"},
    ["Pickaxe"] = {"Swing", "Thrust"},
    ["Spontoon"] = {"Swing", "Thrust"},
    ["Axe"] = {"Swing", "Thrust"},
    ["Hand Axe"] = {"Swing", "Thrust"},
    ["Heavy Sabre"] = {"Swing", "Thrust"},
    ["Stake"] = {"Swing", "Thrust"},
    ["Officer Sabre"] = {"Swing", "Thrust"},
    ["Lance"] = {"Swing", "Thrust"}
}

-- Error handling for missing remotes
local function getRemote(name, path)
    local success, remote = pcall(function() return path:WaitForChild(name, 2) end)
    return success and remote or nil
end

local gib = getRemote("Gib", game.ReplicatedStorage.Remotes)
local currentWeaponRemote = nil
local currentWeaponName = nil

-- Find equipped weapon from the list
local function findWeaponRemote()
    -- Check character first (equipped weapons)
    for weaponName, _ in pairs(weaponConfig) do
        local weapon = char:FindFirstChild(weaponName)
        if weapon then
            local remote = weapon:FindFirstChild("RemoteEvent")
            if remote then
                currentWeaponName = weaponName
                return remote
            end
        end
    end
    
    -- Check backpack if not equipped
    for weaponName, _ in pairs(weaponConfig) do
        local weapon = player.Backpack:FindFirstChild(weaponName)
        if weapon then
            local remote = weapon:FindFirstChild("RemoteEvent")
            if remote then
                currentWeaponName = weaponName
                return remote
            end
        end
    end
    
    warn("No supported weapon found")
    currentWeaponName = nil
    return nil
end

-- Update weapon remote periodically
local function updateWeaponRemote()
    currentWeaponRemote = findWeaponRemote()
    if currentWeaponRemote and currentWeaponName then
        print("Weapon equipped:", currentWeaponName)
    end
end

-- Check if item is valid zombie (excluding Camera folder items)
local function isValidZombie(item)
    if not item:IsA("Model") then return false end
    if not item:FindFirstChild("HumanoidRootPart") then return false end
    
    local folder = item.Parent
    if folder and folder.Name == "Camera" and item.Name ~= "m_Zombie" then
        return false
    end
    
    return true
end

-- Sort zombies by distance
local function getSortedZombies()
    local zombiesList = {}
    for _, item in ipairs(zombies:GetChildren()) do
        if isValidZombie(item) then
            table.insert(zombiesList, item)
        end
    end
    
    table.sort(zombiesList, function(a, b)
        local distA = (a.HumanoidRootPart.Position - root.Position).Magnitude
        local distB = (b.HumanoidRootPart.Position - root.Position).Magnitude
        return distA < distB
    end)
    
    return zombiesList
end

-- Perform weapon attack
local function performAttack(zombie)
    if not currentWeaponRemote or not currentWeaponName then return false end
    
    local zHead = zombie:FindFirstChild("Head")
    if not zHead then return false end
    
    local hitPos = zHead.Position
    local dir = (hitPos - root.Position).Unit
    
    -- Get attack types for this weapon
    local attackTypes = weaponConfig[currentWeaponName]
    if not attackTypes then return false end
    
    -- Try different attack types
    for _, attackType in ipairs(attackTypes) do
        local success = pcall(function()
            currentWeaponRemote:FireServer(attackType, "Over")
            if gib then 
                gib:FireServer(zombie, "Head", hitPos, dir)
            end
            currentWeaponRemote:FireServer("HitZombie", zombie, hitPos, false)
        end)
        
        if success then
            return true
        end
    end
    
    return false
end

-- Main kill aura function
local function attackZombies()
    if not auratrue then return end
    
    -- Update weapon if not found
    if not currentWeaponRemote then
        updateWeaponRemote()
        if not currentWeaponRemote then return end
    end
    
    for _, zombie in ipairs(getSortedZombies()) do
        local zRoot = zombie.HumanoidRootPart
        if zRoot and (zRoot.Position - root.Position).Magnitude <= range then
            performAttack(zombie)
            task.wait(0.1) -- Small delay between attacks
        end
    end
end

-- Keybind setup
game:GetService("UserInputService").InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == keybind then
        auratrue = not auratrue
        print("Kill Aura:", auratrue and "ON" or "OFF")
        
        -- Update weapon when toggling aura
        if auratrue then
            updateWeaponRemote()
        end
    end
end)

-- Monitor weapon changes
game:GetService("RunService").Heartbeat:Connect(function()
    -- Check if weapon changed (equipped/unequipped)
    local currentWeapon = char:FindFirstChildOfClass("Tool")
    if currentWeapon and currentWeapon.Name ~= currentWeaponName then
        updateWeaponRemote()
    elseif not currentWeapon and currentWeaponName then
        updateWeaponRemote() -- Weapon unequipped
    end
end)

-- Main loop
while true do
    attackZombies()
    task.wait(0.1)
end
