local range = 30
local auratrue = false
local keybind = Enum.KeyCode.X
local zombies = workspace:WaitForChild("Zombies")
local player = game.Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local root = char:WaitForChild("HumanoidRootPart")
local humanoid = char:WaitForChild("Humanoid")

-- Weapon configuration
local WEAPONS = {
    Swing = {"Pickaxe", "Sabre", "Axe", "OfficersSabre"},
    Thrust = {"HeavySabre", "Stake", "Lance", "Spontoon"}
}

-- Error handling for missing remotes
local function getRemote(name, path)
    local success, remote = pcall(function() 
        local found = path:FindFirstChild(name)
        if not found then
            found = path:WaitForChild(name, 2)
        end
        return found
    end)
    return success and remote or nil
end

local gib = getRemote("Gib", game.ReplicatedStorage.Remotes)

-- Find equipped weapon with constant inventory checking
local currentWeapon = nil
local currentRemote = nil

local function findWeaponRemote()
    -- Check character first (equipped weapon)
    for _, weaponType in pairs(WEAPONS) do
        for _, weaponName in ipairs(weaponType) do
            local weapon = char:FindFirstChild(weaponName)
            if weapon then
                local remote = weapon:FindFirstChild("RemoteEvent")
                if remote then
                    return weapon, remote, weaponName
                end
            end
        end
    end
    
    -- Check backpack
    if player:FindFirstChild("Backpack") then
        for _, weaponType in pairs(WEAPONS) do
            for _, weaponName in ipairs(weaponType) do
                local weapon = player.Backpack:FindFirstChild(weaponName)
                if weapon then
                    local remote = weapon:FindFirstChild("RemoteEvent")
                    if remote then
                        return weapon, remote, weaponName
                    end
                end
            end
        end
    end
    
    return nil, nil, nil
end

-- Get attack type based on weapon name
local function getAttackType(weaponName)
    for _, weapon in ipairs(WEAPONS.Swing) do
        if weapon == weaponName then
            return "Swing", "Over"
        end
    end
    
    for _, weapon in ipairs(WEAPONS.Thrust) do
        if weapon == weaponName then
            return "Thrust", "Forward"
        end
    end
    
    return "Swing", "Over" -- Default
end

-- Check if item is valid zombie
local function isValidZombie(item)
    if not item:IsA("Model") then return false end
    if not item:FindFirstChild("HumanoidRootPart") then return false end
    
    local folder = item.Parent
    if folder and folder.Name == "Camera" and item.Name ~= "m_Zombie" then
        return false
    end
    
    return true
end

-- Sort zombies by distance
local function getSortedZombies()
    local zombiesList = {}
    for _, item in ipairs(zombies:GetChildren()) do
        if isValidZombie(item) then
            table.insert(zombiesList, item)
        end
    end
    
    table.sort(zombiesList, function(a, b)
        local distA = (a.HumanoidRootPart.Position - root.Position).Magnitude
        local distB = (b.HumanoidRootPart.Position - root.Position).Magnitude
        return distA < distB
    end)
    
    return zombiesList
end

-- Lock character to face zombie
local function faceZombie(zombie)
    if not zombie or not zombie:FindFirstChild("HumanoidRootPart") then return end
    
    local zRoot = zombie.HumanoidRootPart
    local direction = (zRoot.Position - root.Position).Unit
    
    -- Set character's primary part CFrame to face the zombie
    local currentCFrame = root.CFrame
    local lookAtCFrame = CFrame.new(currentCFrame.Position, Vector3.new(zRoot.Position.X, root.Position.Y, zRoot.Position.Z))
    root.CFrame = lookAtCFrame
end

-- Attack ALL zombies in range at once
local function attackAllZombiesInRange()
    if not auratrue or not currentRemote or not currentWeapon then 
        return 0 
    end
    
    local attackedCount = 0
    local zombieList = getSortedZombies()
    local zombiesInRange = {}
    
    -- First, collect all zombies in range
    for _, zombie in ipairs(zombieList) do
        local zRoot = zombie.HumanoidRootPart
        if zRoot and (zRoot.Position - root.Position).Magnitude <= range then
            table.insert(zombiesInRange, zombie)
        end
    end
    
    -- Face and attack all zombies in range
    if #zombiesInRange > 0 then
        -- Face the closest zombie
        faceZombie(zombiesInRange[1])
        
        -- Fire attack once for weapon animation
        local attackType, direction = getAttackType(currentWeapon)
        pcall(function()
            currentRemote:FireServer(attackType, direction)
        end)
        
        -- Attack all zombies in range with individual hits
        for _, zombie in ipairs(zombiesInRange) do
            local zHead = zombie:FindFirstChild("Head")
            if zHead then
                local hitPos = zHead.Position
                local dir = (hitPos - root.Position).Unit
                
                pcall(function()
                    -- Send hit to zombie
                    currentRemote:FireServer("HitZombie", zombie, hitPos, false)
                    
                    -- Send gib damage
                    if gib then 
                        gib:FireServer(zombie, "Head", hitPos, dir)
                    end
                    
                    attackedCount = attackedCount + 1
                end)
            end
        end
    end
    
    return attackedCount
end

-- Constant inventory checking
local function updateWeapon()
    local weapon, remote, weaponName = findWeaponRemote()
    if weapon and remote then
        currentWeapon = weaponName
        currentRemote = remote
        return true
    else
        currentWeapon = nil
        currentRemote = nil
        return false
    end
end

-- Keybind setup
game:GetService("UserInputService").InputBegan:Connect(function(input, processed)
    if not processed and input.KeyCode == keybind then
        auratrue = not auratrue
        print("Kill Aura:", auratrue and "ON" or "OFF")
        if auratrue then
            if not updateWeapon() then
                warn("No weapon found in inventory!")
                auratrue = false
            end
        end
    end
end)

-- Connection to detect weapon changes
char.ChildAdded:Connect(function(child)
    task.wait(0.1) -- Wait a moment for RemoteEvent to be added
    if auratrue then
        updateWeapon()
    end
end)

if player:FindFirstChild("Backpack") then
    player.Backpack.ChildAdded:Connect(function(child)
        task.wait(0.1)
        if auratrue and not currentWeapon then
            updateWeapon()
        end
    end)
end

-- Main loop
while true do
    if auratrue then
        -- Constantly check for weapon updates
        if not currentRemote then
            updateWeapon()
        end
        
        if currentRemote then
            local attacked = attackAllZombiesInRange()
            if attacked > 0 then
                -- print("Attacked " .. attacked .. " zombies")
            end
        else
            -- No weapon found, turn off aura
            auratrue = false
            warn("Weapon lost - Aura disabled")
        end
    end
    task.wait(0.2) -- Increased wait time slightly for performance
end
