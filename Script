local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Configuration
local CONFIG = {
    AURA_RANGE = 50,
    ATTACK_RATE = 0.1, -- seconds between attacks
    ENABLED = false,
    SAFE_MODE = true,
    DEBUG = false,
    WEAPON_CHECK_INTERVAL = 0.5
}

-- Weapon detection list (EXACTLY as you specified)
local WEAPON_NAMES = {
    "pickaxe", "sabre", "spontoon", "Spade", "axe", 
    "hand axe", "heavy sabre", "voivode", "Boarding Axe", 
    "Stake", "officer Sabre"
}

-- Cache
local localPlayer = Players.LocalPlayer
local character = nil
local humanoidRootPart = nil
local gibRemote = nil
local weaponRemote = nil
local currentWeapon = nil
local lastAttackTime = 0
local lastWeaponCheckTime = 0

-- Safe logging function
local function log(message, isError)
    if CONFIG.DEBUG or isError then
        warn("[ZombieAura]: " .. message)
    end
end

-- Safe call wrapper
local function safeCall(func, ...)
    if CONFIG.SAFE_MODE then
        local success, result = pcall(func, ...)
        if not success then
            log("Error: " .. tostring(result), true)
            return nil
        end
        return result
    else
        return func(...)
    end
end

-- ACTIVE weapon finder - scans continuously
local function findWeapon()
    if not localPlayer then return nil end
    
    -- Search in character
    if character then
        for _, item in ipairs(character:GetChildren()) do
            for _, weaponName in ipairs(WEAPON_NAMES) do
                if item.Name:lower() == weaponName:lower() then
                    return item
                end
            end
        end
    end
    
    -- Search in backpack
    local backpack = localPlayer:FindFirstChild("Backpack")
    if backpack then
        for _, item in ipairs(backpack:GetChildren()) do
            for _, weaponName in ipairs(WEAPON_NAMES) do
                if item.Name:lower() == weaponName:lower() then
                    return item
                end
            end
        end
    end
    
    return nil
end

-- Get remote from weapon
local function getWeaponRemote(weapon)
    if not weapon then return nil end
    return weapon:FindFirstChild("RemoteEvent")
end

-- ACTIVE weapon check that runs continuously
local function checkForWeapon()
    local currentTime = tick()
    
    -- Check every WEAPON_CHECK_INTERVAL seconds
    if currentTime - lastWeaponCheckTime < CONFIG.WEAPON_CHECK_INTERVAL then
        return
    end
    
    lastWeaponCheckTime = currentTime
    
    -- If we already have a weapon and it's still valid, keep it
    if currentWeapon and currentWeapon.Parent then
        return
    end
    
    -- Find new weapon
    local newWeapon = safeCall(findWeapon)
    if newWeapon and newWeapon ~= currentWeapon then
        currentWeapon = newWeapon
        weaponRemote = getWeaponRemote(newWeapon)
        if weaponRemote then
            log("Weapon detected: " .. newWeapon.Name)
        end
    elseif not newWeapon and currentWeapon then
        -- Weapon was lost
        log("Weapon lost: " .. currentWeapon.Name)
        currentWeapon = nil
        weaponRemote = nil
    end
end

-- Initialize character
local function initializeCharacter()
    character = localPlayer.Character or localPlayer.CharacterAdded:Wait()
    humanoidRootPart = character:WaitForChild("HumanoidRootPart")
    log("Character ready")
end

-- Initialize remotes
local function initializeRemotes()
    local remotesFolder = ReplicatedStorage:FindFirstChild("Remotes")
    if remotesFolder then
        gibRemote = remotesFolder:FindFirstChild("Gib")
        if gibRemote then
            log("Gib remote ready")
        end
    end
    
    -- Initial weapon check
    checkForWeapon()
end

-- Get zombie folder
local function getZombieFolder()
    local zombies = Workspace:FindFirstChild("Zombies")
    if not zombies then
        zombies = Workspace:FindFirstChild("Zombie") or Workspace:FindFirstChild("Enemies")
    end
    return zombies
end

-- Filter zombies
local function filterZombies(folder)
    local zombies = {}
    
    for _, item in ipairs(folder:GetChildren()) do
        if item:IsA("Model") then
            local folderName = folder.Name
            if folderName == "Camera" then
                if item.Name ~= "m_Zombie" and item:FindFirstChild("HumanoidRootPart") then
                    table.insert(zombies, item)
                end
            else
                if item:FindFirstChild("HumanoidRootPart") then
                    table.insert(zombies, item)
                end
            end
        end
    end
    
    return zombies
end

-- Check range
local function isInRange(zombie)
    if not humanoidRootPart then return false end
    local zombieRoot = zombie:FindFirstChild("HumanoidRootPart")
    if not zombieRoot then return false end
    
    local distance = (zombieRoot.Position - humanoidRootPart.Position).Magnitude
    return distance <= CONFIG.AURA_RANGE
end

-- Attack zombie
local function attackZombie(zombie)
    if not weaponRemote or not gibRemote then return false end
    if not character or not humanoidRootPart then return false end
    
    local head = zombie:FindFirstChild("Head")
    if not head then return false end
    
    local hitPos = head.Position
    local direction = (hitPos - humanoidRootPart.Position).Unit
    
    -- Execute attacks
    local success1 = safeCall(function()
        weaponRemote:FireServer("Swing", "Over")
    end)
    
    local success2 = safeCall(function()
        gibRemote:FireServer(zombie, "Head", hitPos, direction)
    end)
    
    local success3 = safeCall(function()
        weaponRemote:FireServer("HitZombie", zombie, hitPos, false)
    end)
    
    return success1 or success2 or success3
end

-- Main aura function
local function executeAura()
    if not CONFIG.ENABLED then return end
    if not weaponRemote then return end
    
    -- Rate limit
    local currentTime = tick()
    if currentTime - lastAttackTime < CONFIG.ATTACK_RATE then return end
    
    local zombieFolder = getZombieFolder()
    if not zombieFolder then return end
    
    -- Get zombies
    local zombies = filterZombies(zombieFolder)
    if #zombies == 0 then return end
    
    -- Attack closest zombie
    for _, zombie in ipairs(zombies) do
        if isInRange(zombie) then
            local success = attackZombie(zombie)
            if success then
                lastAttackTime = currentTime
                break
            end
        end
    end
end

-- Toggle aura
local function toggleAura()
    CONFIG.ENABLED = not CONFIG.ENABLED
    log("Aura " .. (CONFIG.ENABLED and "ON" or "OFF"))
end

-- Character listeners
local function setupListeners()
    localPlayer.CharacterAdded:Connect(function(newChar)
        safeCall(function()
            character = newChar
            humanoidRootPart = newChar:WaitForChild("HumanoidRootPart")
            log("Character loaded")
        end)
    end)
end

-- Keybinds
local function setupKeybinds()
    local UIS = game:GetService("UserInputService")
    
    UIS.InputBegan:Connect(function(input, processed)
        if processed then return end
        
        -- F1 to toggle aura
        if input.KeyCode == Enum.KeyCode.F1 then
            toggleAura()
        end
        
        -- F2 to force weapon check
        if input.KeyCode == Enum.KeyCode.F2 then
            safeCall(checkForWeapon)
        end
    end)
    
    log("Controls: F1 = Toggle Aura | F2 = Check Weapon")
end

-- Main initialization
local function main()
    log("Initializing Zombie Aura v1.3...")
    
    -- Setup
    safeCall(initializeCharacter)
    safeCall(initializeRemotes)
    safeCall(setupListeners)
    safeCall(setupKeybinds)
    
    -- Main loop - ACTIVE detection runs here
    RunService.Heartbeat:Connect(function(deltaTime)
        -- Always check for weapons (active detection)
        safeCall(checkForWeapon)
        
        -- Execute aura if enabled
        if CONFIG.ENABLED then
            safeCall(executeAura)
        end
    end)
    
    log("Ready! Weapon detection is ACTIVE and continuous")
end

-- Start
local success, err = pcall(main)
if not success then
    warn("[Fatal Error]: " .. tostring(err))
end
