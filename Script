-- Stack Overflow Kill Aura
-- Version: 1.2 (Error Fixed)
-- Fixed: "attempt to call nil value" error

-- Safe service retrieval
local function GetService(serviceName)
    local success, service = pcall(function()
        return game:GetService(serviceName)
    end)
    return success and service or nil
end

-- Get services safely
local Players = GetService("Players")
local Workspace = GetService("Workspace")
local ReplicatedStorage = GetService("ReplicatedStorage")
local UserInputService = GetService("UserInputService")
local RunService = GetService("RunService")

-- Verify all services exist
if not (Players and Workspace and ReplicatedStorage and UserInputService and RunService) then
    warn("Failed to get required services")
    return
end

-- Configuration
local Config = {
    Range = 25,
    SwingAnimation = "Swing",
    SwingType = "Over",
    HitZombieEvent = "HitZombie",
    GibRemoteName = "Gib",
    GibBodyPart = "Head",
    SabreName = "Sabre",
    RemoteEventName = "RemoteEvent",
    Keybind = Enum.KeyCode.F,
    ToggleMode = true,
    ZombiesFolderName = "Zombies" -- Changed from custom path to simple folder name
}

-- State variables
local Player = Players.LocalPlayer
local Character, HumanoidRootPart, ZombiesFolder, GibRemote, SabreRemote
local KillAuraActive = false
local AttackConnection = nil

-- Safe wait for character
local function WaitForCharacter()
    local success, result = pcall(function()
        if Player.Character then
            return Player.Character
        else
            return Player.CharacterAdded:Wait()
        end
    end)
    return success and result or nil
end

-- Safe wait for child
local function SafeWaitForChild(parent, childName, timeout)
    timeout = timeout or 5
    local startTime = tick()
    
    while tick() - startTime < timeout do
        local child = parent:FindFirstChild(childName)
        if child then
            return child
        end
        task.wait(0.1)
    end
    return nil
end

-- Initialize everything safely
local function Initialize()
    print("Initializing Kill Aura...")
    
    -- Get character
    Character = WaitForCharacter()
    if not Character then
        warn("Failed to get character")
        return false
    end
    
    -- Get HumanoidRootPart
    HumanoidRootPart = SafeWaitForChild(Character, "HumanoidRootPart", 3)
    if not HumanoidRootPart then
        warn("Failed to find HumanoidRootPart")
        return false
    end
    
    -- Get Zombies folder
    ZombiesFolder = SafeWaitForChild(Workspace, Config.ZombiesFolderName, 5)
    if not ZombiesFolder then
        warn("Zombies folder not found in Workspace")
        return false
    end
    
    -- Get Gib remote
    local remotesFolder = SafeWaitForChild(ReplicatedStorage, "Remotes", 3)
    if remotesFolder then
        GibRemote = SafeWaitForChild(remotesFolder, Config.GibRemoteName, 3)
    end
    
    if not GibRemote then
        warn("Gib remote not found, continuing without it")
    end
    
    -- Find Sabre
    local function FindSabre()
        -- Check backpack
        local backpack = Player:FindFirstChild("Backpack")
        if backpack then
            local sabre = backpack:FindFirstChild(Config.SabreName)
            if sabre then
                return sabre
            end
        end
        
        -- Check character
        local sabre = Character:FindFirstChild(Config.SabreName)
        if sabre then
            return sabre
        end
        
        return nil
    end
    
    local sabre = FindSabre()
    if sabre then
        SabreRemote = SafeWaitForChild(sabre, Config.RemoteEventName, 2)
    end
    
    if not SabreRemote then
        warn("Sabre remote not found, kill aura will not work")
        return false
    end
    
    print("Initialization complete!")
    return true
end

-- Attempt initialization
if not Initialize() then
    warn("Kill Aura initialization failed")
    return
end

-- Character re-equip handler
Player.CharacterAdded:Connect(function(newChar)
    task.wait(0.5) -- Wait for character to load
    Initialize()
end)

-- Get zombies in range
local function GetZombiesInRange()
    local zombies = {}
    
    if not ZombiesFolder then return zombies end
    
    for _, zombie in ipairs(ZombiesFolder:GetChildren()) do
        if zombie:IsA("Model") then
            local rootPart = zombie:FindFirstChild("HumanoidRootPart")
            local humanoid = zombie:FindFirstChildOfClass("Humanoid")
            
            if rootPart and humanoid then
                local success, health = pcall(function()
                    return humanoid.Health
                end)
                
                if success and health > 0 then
                    local distance = (rootPart.Position - HumanoidRootPart.Position).Magnitude
                    if distance <= Config.Range then
                        table.insert(zombies, {
                            Model = zombie,
                            Root = rootPart,
                            Distance = distance
                        })
                    end
                end
            end
        end
    end
    
    -- Sort by distance
    table.sort(zombies, function(a, b)
        return a.Distance < b.Distance
    end)
    
    return zombies
end

-- Safe remote call
local function SafeFireRemote(remote, ...)
    if not remote then return false end
    
    local args = {...}
    local success = pcall(function()
        remote:FireServer(unpack(args))
    end)
    
    return success
end

-- Attack a zombie
local function AttackZombie(zombieData)
    if not SabreRemote or not KillAuraActive then return false end
    
    local zombie = zombieData.Model
    local rootPart = zombieData.Root
    
    -- Get head
    local head = zombie:FindFirstChild("Head")
    if not head then return false end
    
    -- Calculate direction
    local hitPosition = head.Position
    local direction = (hitPosition - HumanoidRootPart.Position).Unit
    
    -- Execute attack
    local success = true
    
    -- Swing animation
    if not SafeFireRemote(SabreRemote, Config.SwingAnimation, Config.SwingType) then
        success = false
    end
    
    -- Gib attack (if available)
    if GibRemote then
        if not SafeFireRemote(GibRemote, zombie, Config.GibBodyPart, hitPosition, direction) then
            success = false
        end
    end
    
    -- Hit zombie
    if not SafeFireRemote(SabreRemote, Config.HitZombieEvent, zombie, hitPosition, false) then
        success = false
    end
    
    return success
end

-- Toggle kill aura
local function ToggleKillAura(state)
    KillAuraActive = state
    
    -- Disconnect existing connection
    if AttackConnection then
        AttackConnection:Disconnect()
        AttackConnection = nil
    end
    
    -- Start new connection if enabled
    if KillAuraActive then
        AttackConnection = RunService.Heartbeat:Connect(function()
            local zombies = GetZombiesInRange()
            for _, zombieData in ipairs(zombies) do
                if KillAuraActive then
                    AttackZombie(zombieData)
                else
                    break
                end
            end
        end)
        print("Kill Aura: ON")
    else
        print("Kill Aura: OFF")
    end
end

-- Keybind handler
if UserInputService then
    UserInputService.InputBegan:Connect(function(input, processed)
        if processed then return end
        
        if input.KeyCode == Config.Keybind then
            if Config.ToggleMode then
                ToggleKillAura(not KillAuraActive)
            else
                ToggleKillAura(true)
            end
        end
    end)
    
    if not Config.ToggleMode then
        UserInputService.InputEnded:Connect(function(input)
            if input.KeyCode == Config.Keybind then
                ToggleKillAura(false)
            end
        end)
    end
end

-- Cleanup
local function Cleanup()
    if AttackConnection then
        AttackConnection:Disconnect()
        AttackConnection = nil
    end
    KillAuraActive = false
end

-- Auto cleanup on leaving
game:BindToClose(Cleanup)

Player:GetPropertyChangedSignal("Parent"):Connect(function()
    if not Player.Parent then
        Cleanup()
    end
end)

-- Death handler
local humanoid = Character:FindFirstChildOfClass("Humanoid")
if humanoid then
    humanoid.Died:Connect(function()
        Cleanup()
    end)
end

-- Success message
print("Kill Aura loaded successfully!")
print("Press " .. Config.Keybind.Name .. " to toggle")
