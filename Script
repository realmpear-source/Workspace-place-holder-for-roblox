-- Services
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- Configuration
local Config = {
    Range = 37,
    SwingAnimation = "Swing",
    SwingType = "Over",
    HitZombieEvent = "HitZombie",
    GibRemoteName = "Gib",
    GibBodyPart = "Head",
    Keybind = Enum.KeyCode.F,
    ToggleMode = true,
    
    -- List of supported weapons
    WeaponNames = {
        "Pickaxe", "Sabre", "Spontoon", "Shovel", "Axe", 
        "Hand Axe", "Heavy Sabre", "Voivode", "Boarding Axe", 
        "Stake", "Officer Sabre"
    }
}

-- State variables
local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
local ZombiesFolder = Workspace:WaitForChild("Zombies")
local GibRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild(Config.GibRemoteName)
local CurrentWeaponRemote = nil
local KillAuraActive = false

-- Function to find the correct zombie folder
local function GetZombiesFolder()
    local function SearchFolder(folder, targetName)
        for _, item in ipairs(folder:GetChildren()) do
            if folder.Name == "Camera" and item.Name ~= "m_Zombie" then
                -- This is the pattern from your description
                if item:IsA("Folder") then
                    local result = SearchFolder(item, targetName)
                    if result then return result end
                end
            elseif item.Name == targetName then
                return item
            elseif item:IsA("Folder") then
                local result = SearchFolder(item, targetName)
                if result then return result end
            end
        end
        return nil
    end
    
    -- Try direct path first
    if Workspace:FindFirstChild("Zombies") then
        return Workspace.Zombies
    end
    
    -- Search through workspace
    return SearchFolder(Workspace, "Zombies")
end

-- Update zombies folder with search function
ZombiesFolder = GetZombiesFolder() or Workspace:WaitForChild("Zombies")

-- Function to find equipped weapon remote
local function FindWeaponRemote()
    -- Check character first (equipped weapons)
    for _, weaponName in ipairs(Config.WeaponNames) do
        local weapon = Character:FindFirstChild(weaponName)
        if weapon then
            local remote = weapon:FindFirstChild("RemoteEvent")
            if remote then
                return remote
            end
        end
    end
    
    -- Check backpack (unequipped weapons)
    for _, weaponName in ipairs(Config.WeaponNames) do
        local weapon = Player.Backpack:FindFirstChild(weaponName)
        if weapon then
            local remote = weapon:FindFirstChild("RemoteEvent")
            if remote then
                return remote
            end
        end
    end
    
    return nil
end

-- Initialize weapon remote
CurrentWeaponRemote = FindWeaponRemote()
if not CurrentWeaponRemote then
    warn("No supported weapon found")
    return
end

-- Character re-equip handler
Player.CharacterAdded:Connect(function(newChar)
    Character = newChar
    HumanoidRootPart = newChar:WaitForChild("HumanoidRootPart")
    task.wait(0.3) -- Wait for equipment to load
    CurrentWeaponRemote = FindWeaponRemote()
end)

-- Get zombies within range
local function GetZombiesInRange()
    local ZombiesInRange = {}
    
    for _, Zombie in ipairs(ZombiesFolder:GetChildren()) do
        if Zombie:IsA("Model") then
            local ZRoot = Zombie:FindFirstChild("HumanoidRootPart")
            local ZHumanoid = Zombie:FindFirstChildOfClass("Humanoid")
            
            if ZRoot and ZHumanoid and ZHumanoid.Health > 0 then
                local Distance = (ZRoot.Position - HumanoidRootPart.Position).Magnitude
                if Distance <= Config.Range then
                    table.insert(ZombiesInRange, {
                        Model = Zombie,
                        Root = ZRoot,
                        Distance = Distance
                    })
                end
            end
        end
    end
    
    -- Sort by distance (closest first)
    table.sort(ZombiesInRange, function(a, b)
        return a.Distance < b.Distance
    end)
    
    return ZombiesInRange
end

-- Attack a zombie
local function AttackZombie(ZombieData)
    if not CurrentWeaponRemote then 
        CurrentWeaponRemote = FindWeaponRemote()
        if not CurrentWeaponRemote then return false end
    end
    
    local Zombie = ZombieData.Model
    local ZHead = Zombie:FindFirstChild("Head")
    local ZRoot = ZombieData.Root
    
    if not ZHead then return false end
    
    local HitPosition = ZHead.Position
    local Direction = (HitPosition - HumanoidRootPart.Position).Unit
    
    -- Execute attacks without cooldown
    local function FireRemote(...)
        local success, result = pcall(function()
            CurrentWeaponRemote:FireServer(...)
        end)
        return success
    end
    
    -- Swing animation
    FireRemote(Config.SwingAnimation, Config.SwingType)
    
    -- Gib remote
    pcall(function()
        GibRemote:FireServer(Zombie, Config.GibBodyPart, HitPosition, Direction)
    end)
    
    -- Hit zombie
    FireRemote(Config.HitZombieEvent, Zombie, HitPosition, false)
    
    return true
end

-- Main attack loop
local AttackConnection
local function ToggleKillAura(State)
    KillAuraActive = State
    
    if AttackConnection then
        AttackConnection:Disconnect()
        AttackConnection = nil
    end
    
    if KillAuraActive then
        AttackConnection = RunService.Heartbeat:Connect(function()
            -- Check for weapon changes every frame
            if not CurrentWeaponRemote then
                CurrentWeaponRemote = FindWeaponRemote()
                if not CurrentWeaponRemote then
                    ToggleKillAura(false)
                    return
                end
            end
            
            local ZombiesInRange = GetZombiesInRange()
            
            -- Attack all zombies in range without cooldown
            for _, ZombieData in ipairs(ZombiesInRange) do
                AttackZombie(ZombieData)
            end
        end)
        
        print("Kill Aura: ON")
    else
        print("Kill Aura: OFF")
    end
end

-- Keybind handler
UserInputService.InputBegan:Connect(function(Input, Processed)
    if Processed then return end
    
    if Input.KeyCode == Config.Keybind then
        if Config.ToggleMode then
            ToggleKillAura(not KillAuraActive)
        else
            -- Hold to activate mode
            ToggleKillAura(true)
        end
    end
end)

UserInputService.InputEnded:Connect(function(Input)
    if not Config.ToggleMode and Input.KeyCode == Config.Keybind then
        ToggleKillAura(false)
    end
end)

-- Cleanup on script termination
game:GetService("Players").PlayerRemoving:Connect(function(LeavingPlayer)
    if LeavingPlayer == Player then
        ToggleKillAura(false)
    end
end)

-- Auto-disable on character death
Character:GetPropertyChangedSignal("Parent"):Connect(function()
    if not Character.Parent then
        ToggleKillAura(false)
    end
end)

Character:WaitForChild("Humanoid").Died:Connect(function()
    ToggleKillAura(false)
end)

-- Monitor for weapon changes while equipped
RunService.Heartbeat:Connect(function()
    if KillAuraActive then
        -- Quick check if current weapon is still valid
        if CurrentWeaponRemote and not CurrentWeaponRemote.Parent then
            CurrentWeaponRemote = FindWeaponRemote()
        end
    end
end)

-- Initialization message
local weaponList = table.concat(Config.WeaponNames, ", ")
print(string.format([[
Stack Overflow Kill Aura v2.0 Initialized
Keybind: %s
Range: %d
Mode: %s
Supported Weapons: %s
]], Config.Keybind.Name, Config.Range, Config.ToggleMode and "Toggle" : "Hold", weaponList))
print("Press " .. Config.Keybind.Name .. " to toggle kill aura")

-- Export configuration for easy modification
return {
    Config = Config,
    ToggleKillAura = ToggleKillAura,
    GetStatus = function() return KillAuraActive end,
    UpdateWeaponList = function(newList)
        Config.WeaponNames = newList
        CurrentWeaponRemote = FindWeaponRemote()
    end
}
