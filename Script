-- Services
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- Configuration
local Config = {
    Range = 25,
    SwingAnimation = "Swing",
    SwingType = "Over",
    HitZombieEvent = "HitZombie",
    GibRemoteName = "Gib",
    GibBodyPart = "Head",
    SabreName = "Sabre",
    RemoteEventName = "RemoteEvent",
    Keybind = Enum.KeyCode.F,
    ToggleMode = true,
    FilterFolderName = "Camera",
    ExcludeModelName = "m_Zombie"
}

-- State variables
local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
local GibRemote = nil
local SabreRemote = nil
local KillAuraActive = false

-- Safe initialization
local function SafeInitialize()
    -- Get Gib remote
    local success, result = pcall(function()
        return ReplicatedStorage:WaitForChild("Remotes"):WaitForChild(Config.GibRemoteName)
    end)
    
    if success then
        GibRemote = result
    else
        warn("Gib Remote not found")
        return false
    end
    
    -- Find Sabre RemoteEvent
    local function FindSabreRemote()
        local backpackSabre = Player.Backpack:FindFirstChild(Config.SabreName)
        local characterSabre = Character:FindFirstChild(Config.SabreName)
        
        local Sabre = backpackSabre or characterSabre
        if Sabre then
            return Sabre:WaitForChild(Config.RemoteEventName)
        end
        return nil
    end
    
    SabreRemote = FindSabreRemote()
    return SabreRemote ~= nil
end

-- Initialize
if not SafeInitialize() then
    warn("Kill Aura initialization failed - waiting for equipment")
    
    -- Try again after a delay
    task.wait(2)
    SafeInitialize()
end

-- Character handler
Player.CharacterAdded:Connect(function(newChar)
    task.wait(1)
    Character = newChar
    HumanoidRootPart = newChar:WaitForChild("HumanoidRootPart")
    SafeInitialize()
end)

-- Get zombies in range
local function GetZombiesInRange()
    local ZombiesInRange = {}
    
    -- Try multiple zombie locations
    local zombieLocations = {
        Workspace:FindFirstChild("Zombies"),
        Workspace:FindFirstChild("Camera"),
        Workspace
    }
    
    for _, location in ipairs(zombieLocations) do
        if location then
            for _, zombie in ipairs(location:GetChildren()) do
                if zombie:IsA("Model") and zombie.Name ~= Config.ExcludeModelName then
                    local humanoidRoot = zombie:FindFirstChild("HumanoidRootPart")
                    local humanoid = zombie:FindFirstChildOfClass("Humanoid")
                    
                    if humanoidRoot and humanoid and humanoid.Health > 0 then
                        local distance = (humanoidRoot.Position - HumanoidRootPart.Position).Magnitude
                        if distance <= Config.Range then
                            table.insert(ZombiesInRange, {
                                Model = zombie,
                                Root = humanoidRoot,
                                Distance = distance
                            })
                        end
                    end
                end
            end
        end
    end
    
    -- Sort by distance
    table.sort(ZombiesInRange, function(a, b)
        return a.Distance < b.Distance
    end)
    
    return ZombiesInRange
end

-- Attack function
local function AttackZombie(zombieData)
    if not SabreRemote or not KillAuraActive then return end
    
    local zombie = zombieData.Model
    local head = zombie:FindFirstChild("Head")
    
    if not head then return end
    
    -- Attack sequence
    local hitPos = head.Position
    local dir = (hitPos - HumanoidRootPart.Position).Unit
    
    -- Swing
    pcall(function()
        SabreRemote:FireServer(Config.SwingAnimation, Config.SwingType)
    end)
    
    -- Gib
    if GibRemote then
        pcall(function()
            GibRemote:FireServer(zombie, Config.GibBodyPart, hitPos, dir)
        end)
    end
    
    -- Hit
    pcall(function()
        SabreRemote:FireServer(Config.HitZombieEvent, zombie, hitPos, false)
    end)
end

-- Main loop
local AttackConnection
local function ToggleKillAura(state)
    KillAuraActive = state
    
    if AttackConnection then
        AttackConnection:Disconnect()
    end
    
    if KillAuraActive then
        AttackConnection = RunService.Heartbeat:Connect(function()
            local zombies = GetZombiesInRange()
            for _, zombieData in ipairs(zombies) do
                AttackZombie(zombieData)
                if not KillAuraActive then break end
            end
        end)
        print("Kill Aura: ON")
    else
        print("Kill Aura: OFF")
    end
end

-- Keybind handler
UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    
    if input.KeyCode == Config.Keybind then
        ToggleKillAura(not KillAuraActive)
    end
end)

-- Cleanup
game:GetService("Players").PlayerRemoving:Connect(function(player)
    if player == Player then
        ToggleKillAura(false)
    end
end)

-- Auto-disable on death
local humanoid = Character:FindFirstChildOfClass("Humanoid")
if humanoid then
    humanoid.Died:Connect(function()
        ToggleKillAura(false)
    end)
end

-- Loadstring function for GitHub
local function LoadFromGitHub()
end

-- Export
return {
    Toggle = ToggleKillAura,
    IsActive = function() return KillAuraActive end,
    SetKeybind = function(key) Config.Keybind = key end,
    SetRange = function(range) Config.Range = range end
}
