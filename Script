local Config = {
    Range = 50,
    AuraEnabled = false,
    ScanCooldown = 0.1, -- Fast scanning without delay
    DebugMode = false
}

-- Services
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

-- Player references
local Player = Players.LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")

-- Remote detection system
local WeaponRemotes = {}
local GibRemote = nil

-- Zombie folder scanning configuration
local ZombieFolders = {
    "Zombies",
    "Camera", -- Additional folder to scan
    "Enemies" -- Fallback folder name
}

-- ============================================
-- SAFETY & ERROR HANDLING FUNCTIONS
-- ============================================

local function SafeCall(func, ...)
    local success, result = pcall(func, ...)
    if not success and Config.DebugMode then
        warn("[SafeCall Error]:", result)
    end
    return success, result
end

local function Log(message)
    if Config.DebugMode then
        print("[Aura]: " .. message)
    end
end

-- ============================================
-- WEAPON DETECTION SYSTEM
-- ============================================

local function FindWeaponRemote()
    local weaponNames = {
        "Sabre", "Pickaxe", "Spontoon", "Spade", "Axe", 
        "Hand Axe", "Heavy Sabre", "Voivode", "Boarding Axe", 
        "Stake", "Officer Sabre"
    }
    
    -- Search priority: Character -> Backpack -> Workspace
    local searchLocations = {
        Character,
        Player:FindFirstChild("Backpack") or Player.Backpack,
        Workspace
    }
    
    for _, location in ipairs(searchLocations) do
        if location then
            for _, weaponName in ipairs(weaponNames) do
                local weapon = location:FindFirstChild(weaponName)
                if weapon then
                    local remote = weapon:FindFirstChild("RemoteEvent")
                    if remote then
                        Log("Found weapon: " .. weaponName)
                        return remote
                    end
                end
            end
        end
    end
    
    return nil
end

-- ============================================
-- REMOTE SETUP WITH FALLBACK
-- ============================================

local function SetupRemotes()
    -- Find Gib remote
    SafeCall(function()
        GibRemote = ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Gib")
        Log("Gib remote found")
    end)
    
    -- Find weapon remote
    local weaponRemote = FindWeaponRemote()
    if weaponRemote then
        WeaponRemotes["Primary"] = weaponRemote
        Log("Weapon remote initialized")
    else
        warn("[Warning]: No weapon remote found. Aura will not function.")
    end
end

-- ============================================
-- ZOMBIE SCANNING SYSTEM
-- ============================================

local function GetZombieFolders()
    local folders = {}
    
    for _, folderName in ipairs(ZombieFolders) do
        local folder = Workspace:FindFirstChild(folderName)
        if folder then
            table.insert(folders, folder)
            Log("Found zombie folder: " .. folderName)
        end
    end
    
    return folders
end

local function ScanForZombies()
    local zombies = {}
    local zombieFolders = GetZombieFolders()
    
    for _, folder in ipairs(zombieFolders) do
        SafeCall(function()
            for _, item in ipairs(folder:GetChildren()) do
                -- Filter for zombies only (excluding non-zombie models)
                if folder.Name == "Camera" and item.Name == "m_Zombie" then
                    if item:IsA("Model") and item:FindFirstChild("HumanoidRootPart") then
                        table.insert(zombies, item)
                    end
                elseif folder.Name ~= "Camera" then
                    -- For other folders, include all models with HumanoidRootPart
                    if item:IsA("Model") and item:FindFirstChild("HumanoidRootPart") then
                        table.insert(zombies, item)
                    end
                end
            end
        end)
    end
    
    return zombies
end

local function SortZombiesByDistance(zombies)
    table.sort(zombies, function(a, b)
        local aDist = (a.HumanoidRootPart.Position - HumanoidRootPart.Position).Magnitude
        local bDist = (b.HumanoidRootPart.Position - HumanoidRootPart.Position).Magnitude
        return aDist < bDist
    end)
    return zombies
end

local function IsZombieInRange(zombie)
    local zombieRoot = zombie:FindFirstChild("HumanoidRootPart")
    if not zombieRoot then return false end
    
    local distance = (zombieRoot.Position - HumanoidRootPart.Position).Magnitude
    return distance <= Config.Range
end

-- ============================================
-- ATTACK SYSTEM WITH SAFETY
-- ============================================

local function AttackZombie(zombie)
    if not WeaponRemotes["Primary"] or not GibRemote then return end
    
    SafeCall(function()
        local head = zombie:FindFirstChild("Head")
        if not head then return end
        
        local hitPosition = head.Position
        local direction = (hitPosition - HumanoidRootPart.Position).Unit
        
        -- Swing animation
        WeaponRemotes["Primary"]:FireServer("Swing", "Over")
        
        -- Gib remote
        GibRemote:FireServer(zombie, "Head", hitPosition, direction)
        
        -- Hit detection
        WeaponRemotes["Primary"]:FireServer("HitZombie", zombie, hitPosition, false)
        
        Log("Attacked zombie: " .. zombie.Name)
    end)
end

local function ExecuteAura()
    if not Config.AuraEnabled then return end
    if not HumanoidRootPart then return end
    
    SafeCall(function()
        local zombies = ScanForZombies()
        local sortedZombies = SortZombiesByDistance(zombies)
        
        for _, zombie in ipairs(sortedZombies) do
            if IsZombieInRange(zombie) then
                AttackZombie(zombie)
            end
        end
    end)
end

-- ============================================
-- INITIALIZATION & CONTROLS
-- ============================================

local function Initialize()
    Log("Initializing Kill Aura...")
    
    -- Wait for character to fully load
    if not Character:FindFirstChild("Humanoid") then
        Character:WaitForChild("Humanoid")
    end
    
    SetupRemotes()
    
    -- Character respawn handler
    Player.CharacterAdded:Connect(function(newChar)
        Character = newChar
        HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
        Log("Character respawned - references updated")
    end)
    
    -- Main aura loop
    RunService.Heartbeat:Connect(function()
        ExecuteAura()
    end)
    
    Log("Initialization complete. Aura ready.")
end

-- ============================================
-- CONTROL FUNCTIONS (External API)
-- ============================================

local AuraAPI = {}

function AuraAPI:Toggle()
    Config.AuraEnabled = not Config.AuraEnabled
    Log("Aura " .. (Config.AuraEnabled and "ENABLED" or "DISABLED"))
    return Config.AuraEnabled
end

function AuraAPI:SetRange(newRange)
    if type(newRange) == "number" and newRange > 0 then
        Config.Range = newRange
        Log("Range set to: " .. newRange)
        return true
    end
    return false
end

function AuraAPI:GetStatus()
    return {
        Enabled = Config.AuraEnabled,
        Range = Config.Range,
        WeaponFound = WeaponRemotes["Primary"] ~= nil,
        GibFound = GibRemote ~= nil
    }
end

function AuraAPI:Reinitialize()
    SetupRemotes()
    Log("Reinitialized weapon detection")
end

-- ============================================
-- STARTUP
-- ============================================

-- Delay initialization to ensure game is loaded
task.wait(2)
Initialize()

-- Return API for external control
return AuraAPI
